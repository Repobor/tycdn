var c=(o=>(o.LOADING="loading",o.LOADED="loaded",o.ERROR="error",o))(c||{});const h=typeof window<"u"&&window!==null,p=I(),O=Object.prototype.propertyIsEnumerable,b=Object.getOwnPropertySymbols;function u(o){return typeof o=="function"||toString.call(o)==="[object Object]"}function _(o){return typeof o=="object"?o===null:typeof o!="function"}function g(o){return o!=="__proto__"&&o!=="constructor"&&o!=="prototype"}function I(){return h&&"IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in window.IntersectionObserverEntry.prototype?("isIntersecting"in window.IntersectionObserverEntry.prototype||Object.defineProperty(window.IntersectionObserverEntry.prototype,"isIntersecting",{get(){return this.intersectionRatio>0}}),!0):!1}function m(o,...t){if(!u(o))throw new TypeError("expected the first argument to be an object");if(t.length===0||typeof Symbol!="function"||typeof b!="function")return o;for(const e of t){const r=b(e);for(const i of r)O.call(e,i)&&(o[i]=e[i])}return o}function A(o,...t){let e=0;for(_(o)&&(o=t[e++]),o||(o={});e<t.length;e++)if(u(t[e])){for(const r of Object.keys(t[e]))g(r)&&(u(o[r])&&u(t[e][r])?A(o[r],t[e][r]):o[r]=t[e][r]);m(o,t[e])}return o}const d="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",y="",w={rootMargin:"0px",threshold:0},a="data-lazy-timeout-id";class v{constructor(t){this.options={loading:d,error:y,observerOptions:w,log:!0,lifecycle:{}},this._images=new WeakMap,this.config(t)}config(t={}){A(this.options,t)}mount(t,e){if(!t)return;const{src:r,loading:i,error:s,lifecycle:n,delay:l}=this._valueFormatter(typeof e=="string"?e:e.value);this._lifecycle(c.LOADING,n,t),t.setAttribute("src",i||d),p||(this.loadImages(t,r,s,n),this._log(()=>{throw new Error("Not support IntersectionObserver!")})),this._initIntersectionObserver(t,r,s,n,l)}update(t,e){if(!t)return;this._realObserver(t)?.unobserve(t);const{src:r,error:i,lifecycle:s,delay:n}=this._valueFormatter(typeof e=="string"?e:e.value);this._initIntersectionObserver(t,r,i,s,n)}unmount(t){!t||(this._realObserver(t)?.unobserve(t),this._images.delete(t))}loadImages(t,e,r,i){this._setImageSrc(t,e,r,i)}_setImageSrc(t,e,r,i){t.tagName.toLowerCase()==="img"?(e&&t.getAttribute("src")!==e&&t.setAttribute("src",e),this._listenImageStatus(t,()=>{this._lifecycle(c.LOADED,i,t)},()=>{t.onload=null,this._lifecycle(c.ERROR,i,t),this._realObserver(t)?.disconnect(),r&&t.getAttribute("src")!==r&&t.setAttribute("src",r),this._log(()=>{throw new Error(`Image failed to load!And failed src was: ${e} `)})})):t.style.backgroundImage=`url('${e}')`}_initIntersectionObserver(t,e,r,i,s){const n=this.options.observerOptions;this._images.set(t,new IntersectionObserver(l=>{Array.prototype.forEach.call(l,f=>{s&&s>0?this._delayedIntersectionCallback(t,f,s,e,r,i):this._intersectionCallback(t,f,e,r,i)})},n)),this._realObserver(t)?.observe(t)}_intersectionCallback(t,e,r,i,s){e.isIntersecting&&(this._realObserver(t)?.unobserve(e.target),this._setImageSrc(t,r,i,s))}_delayedIntersectionCallback(t,e,r,i,s,n){if(e.isIntersecting){if(e.target.hasAttribute(a))return;const l=setTimeout(()=>{this._intersectionCallback(t,e,i,s,n),e.target.removeAttribute(a)},r);e.target.setAttribute(a,String(l))}else e.target.hasAttribute(a)&&(clearTimeout(Number(e.target.getAttribute(a))),e.target.removeAttribute(a))}_listenImageStatus(t,e,r){t.onload=e,t.onerror=r}_valueFormatter(t){let e=t,r=this.options.loading,i=this.options.error,s=this.options.lifecycle,n=this.options.delay;return u(t)&&(e=t.src,r=t.loading||this.options.loading,i=t.error||this.options.error,s=t.lifecycle||this.options.lifecycle,n=t.delay||this.options.delay),{src:e,loading:r,error:i,lifecycle:s,delay:n}}_log(t){this.options.log&&t()}_lifecycle(t,e,r){switch(t){case c.LOADING:r?.setAttribute("lazy",c.LOADING),e?.loading&&e.loading(r);break;case c.LOADED:r?.setAttribute("lazy",c.LOADED),e?.loaded&&e.loaded(r);break;case c.ERROR:r?.setAttribute("lazy",c.ERROR),e?.error&&e.error(r);break}}_realObserver(t){return this._images.get(t)}}const E={install(o,t){const e=new v(t);o.config.globalProperties.$Lazyload=e,o.provide("Lazyload",e),o.directive("lazy",{mounted:e.mount.bind(e),updated:e.update.bind(e),unmounted:e.unmount.bind(e)})}};export{E as i};
